name: CI

on:
  pull_request:
    branches: ["main", "playground"]
  push:
    branches: ["main", "playground"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  version-change-check:
    name: Version Change Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check version change isolation
        id: version_check
        run: |
          # PR references for checking modified files
          BASE_REF="${{ github.event.pull_request.base.sha }}"
          HEAD_REF="${{ github.event.pull_request.head.sha }}"

          # Extract current version from Cargo.toml
          CURRENT_VERSION=$(grep '^version = ' Cargo.toml | head -1 | cut -d'"' -f2)

          # Get the latest version tag to compare semantic versioning
          LATEST_TAG=$(git tag -l "v*" --sort=-v:refname | head -1)

          if [ -z "$LATEST_TAG" ]; then
            # No tags yet, this is the first release
            echo "ℹ️  No previous version tags found"
            PREVIOUS_VERSION="0.0.0"
          else
            # Get version from the latest tag
            PREVIOUS_VERSION=$(git show $LATEST_TAG:Cargo.toml | grep '^version = ' | head -1 | cut -d'"' -f2)
            echo "ℹ️  Latest released version: $LATEST_TAG ($PREVIOUS_VERSION)"
          fi

          # If version changed
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "⚠️  Version changed: $PREVIOUS_VERSION → $CURRENT_VERSION"

            # Parse version numbers
            PREV_MAJOR=$(echo $PREVIOUS_VERSION | cut -d. -f1)
            PREV_MINOR=$(echo $PREVIOUS_VERSION | cut -d. -f2)
            PREV_PATCH=$(echo $PREVIOUS_VERSION | cut -d. -f3)

            CURR_MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
            CURR_MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
            CURR_PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)

            # Validate semver bump
            VALID_BUMP=false

            # Check for valid major bump: X.Y.Z -> (X+1).0.0
            if [ $CURR_MAJOR -eq $((PREV_MAJOR + 1)) ] && [ $CURR_MINOR -eq 0 ] && [ $CURR_PATCH -eq 0 ]; then
              echo "✅ Valid MAJOR version bump"
              VALID_BUMP=true
            # Check for valid minor bump: X.Y.Z -> X.(Y+1).0
            elif [ $CURR_MAJOR -eq $PREV_MAJOR ] && [ $CURR_MINOR -eq $((PREV_MINOR + 1)) ] && [ $CURR_PATCH -eq 0 ]; then
              echo "✅ Valid MINOR version bump"
              VALID_BUMP=true
            # Check for valid patch bump: X.Y.Z -> X.Y.(Z+1)
            elif [ $CURR_MAJOR -eq $PREV_MAJOR ] && [ $CURR_MINOR -eq $PREV_MINOR ] && [ $CURR_PATCH -eq $((PREV_PATCH + 1)) ]; then
              echo "✅ Valid PATCH version bump"
              VALID_BUMP=true
            fi

            if [ "$VALID_BUMP" = false ]; then
              echo ""
              echo "❌ ERROR: Invalid version bump from $PREVIOUS_VERSION to $CURRENT_VERSION"
              echo ""
              echo "Valid options:"
              echo "  • MAJOR: $((PREV_MAJOR + 1)).0.0"
              echo "  • MINOR: $PREV_MAJOR.$((PREV_MINOR + 1)).0"
              echo "  • PATCH: $PREV_MAJOR.$PREV_MINOR.$((PREV_PATCH + 1))"
              exit 1
            fi

            # Validate modified files (only for PRs)
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              # List all modified files in the PR (total diff, not just last commit)
              CHANGED_FILES=$(git diff --name-only $BASE_REF $HEAD_REF)
              NUM_CHANGED=$(echo "$CHANGED_FILES" | wc -l)

              # Version bump should modify exactly Cargo.toml and Cargo.lock
              if [ $NUM_CHANGED -ne 2 ]; then
                echo ""
                echo "❌ ERROR: Version bump must modify exactly Cargo.toml and Cargo.lock"
                echo ""
                echo "Files modified in this PR ($NUM_CHANGED):"
                echo "$CHANGED_FILES"
                exit 1
              fi

              # Check if the modified files are exactly Cargo.toml and Cargo.lock
              if ! echo "$CHANGED_FILES" | grep -q "^Cargo.toml$"; then
                echo ""
                echo "❌ ERROR: Cargo.toml must be modified for version bump"
                exit 1
              fi

              if ! echo "$CHANGED_FILES" | grep -q "^Cargo.lock$"; then
                echo ""
                echo "❌ ERROR: Cargo.lock must be modified for version bump"
                exit 1
              fi

              # Validate that both files have the same version
              LOCK_VERSION=$(grep '^version = ' Cargo.lock | head -1 | cut -d'"' -f2)

              if [ "$CURRENT_VERSION" != "$LOCK_VERSION" ]; then
                echo ""
                echo "❌ ERROR: Version mismatch between Cargo.toml and Cargo.lock"
                echo "  Cargo.toml: $CURRENT_VERSION"
                echo "  Cargo.lock: $LOCK_VERSION"
                exit 1
              fi

              echo "✅ Only Cargo.toml and Cargo.lock modified with matching versions - ready to release"
            fi

            echo "✅ All validations passed"
          else
            echo "✅ No version change detected"
          fi

  format:
    name: Format Check
    needs: version-change-check
    if: |
      always() &&
      (needs.version-change-check.result == 'success' ||
       needs.version-change-check.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy Lints
    needs: version-change-check
    if: |
      always() &&
      (needs.version-change-check.result == 'success' ||
       needs.version-change-check.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - uses: Swatinem/rust-cache@v2

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    name: Tests
    needs: version-change-check
    if: |
      always() &&
      (needs.version-change-check.result == 'success' ||
       needs.version-change-check.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install OpenCL
        run: |
          sudo apt-get update
          sudo apt-get install -y ocl-icd-opencl-dev opencl-headers pocl-opencl-icd

      - uses: Swatinem/rust-cache@v2

      - name: Run tests
        run: cargo test --verbose

  build:
    name: Build
    needs: version-change-check
    if: |
      always() &&
      (needs.version-change-check.result == 'success' ||
       needs.version-change-check.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install OpenCL
        run: |
          sudo apt-get update
          sudo apt-get install -y ocl-icd-opencl-dev opencl-headers pocl-opencl-icd

      - uses: Swatinem/rust-cache@v2

      - name: Build
        run: cargo build --verbose --release
