name: CI

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  version-change-check:
    name: Version Change Validation
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check version change isolation
        run: |
          BASE_REF="${{ github.event.pull_request.base.sha }}"

          # Extract current version from Cargo.toml
          CURRENT_VERSION=$(grep '^version = ' Cargo.toml | head -1 | cut -d'"' -f2)

          # Extract previous version from Cargo.toml
          PREVIOUS_VERSION=$(git show $BASE_REF:Cargo.toml | grep '^version = ' | head -1 | cut -d'"' -f2)

          # If version changed
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "⚠️  Version changed: $PREVIOUS_VERSION → $CURRENT_VERSION"

            # Parse version numbers
            PREV_MAJOR=$(echo $PREVIOUS_VERSION | cut -d. -f1)
            PREV_MINOR=$(echo $PREVIOUS_VERSION | cut -d. -f2)
            PREV_PATCH=$(echo $PREVIOUS_VERSION | cut -d. -f3)

            CURR_MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
            CURR_MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
            CURR_PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)

            # Validate semver bump
            VALID_BUMP=false

            # Check for valid major bump: X.Y.Z -> (X+1).0.0
            if [ $CURR_MAJOR -eq $((PREV_MAJOR + 1)) ] && [ $CURR_MINOR -eq 0 ] && [ $CURR_PATCH -eq 0 ]; then
              echo "✅ Valid MAJOR version bump"
              VALID_BUMP=true
            # Check for valid minor bump: X.Y.Z -> X.(Y+1).0
            elif [ $CURR_MAJOR -eq $PREV_MAJOR ] && [ $CURR_MINOR -eq $((PREV_MINOR + 1)) ] && [ $CURR_PATCH -eq 0 ]; then
              echo "✅ Valid MINOR version bump"
              VALID_BUMP=true
            # Check for valid patch bump: X.Y.Z -> X.Y.(Z+1)
            elif [ $CURR_MAJOR -eq $PREV_MAJOR ] && [ $CURR_MINOR -eq $PREV_MINOR ] && [ $CURR_PATCH -eq $((PREV_PATCH + 1)) ]; then
              echo "✅ Valid PATCH version bump"
              VALID_BUMP=true
            fi

            if [ "$VALID_BUMP" = false ]; then
              echo ""
              echo "❌ ERROR: Invalid version bump from $PREVIOUS_VERSION to $CURRENT_VERSION"
              echo ""
              echo "Valid options:"
              echo "  • MAJOR: $((PREV_MAJOR + 1)).0.0"
              echo "  • MINOR: $PREV_MAJOR.$((PREV_MINOR + 1)).0"
              echo "  • PATCH: $PREV_MAJOR.$PREV_MINOR.$((PREV_PATCH + 1))"
              exit 1
            fi

            # List all modified files in the PR
            CHANGED_FILES=$(git diff --name-only $BASE_REF HEAD)
            NUM_CHANGED=$(echo "$CHANGED_FILES" | wc -l)

            # If more than 1 file was modified (besides Cargo.toml)
            if [ $NUM_CHANGED -gt 1 ]; then
              echo ""
              echo "❌ ERROR: Version bump must only modify Cargo.toml"
              echo ""
              echo "Files modified in this PR:"
              echo "$CHANGED_FILES"
              exit 1
            fi

            # Check if the only modified file is Cargo.toml
            if [ "$CHANGED_FILES" != "Cargo.toml" ]; then
              echo ""
              echo "❌ ERROR: Version changed but Cargo.toml is not the only modified file"
              echo ""
              echo "Files modified:"
              echo "$CHANGED_FILES"
              exit 1
            fi

            echo "✅ Only Cargo.toml modified - ready to release"
          else
            echo "✅ No version change detected"
          fi

  format:
    name: Format Check
    needs: version-change-check
    if: |
      always() &&
      (needs.version-change-check.result == 'success' ||
       needs.version-change-check.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy Lints
    needs: version-change-check
    if: |
      always() &&
      (needs.version-change-check.result == 'success' ||
       needs.version-change-check.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - uses: Swatinem/rust-cache@v2

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    name: Tests
    needs: version-change-check
    if: |
      always() &&
      (needs.version-change-check.result == 'success' ||
       needs.version-change-check.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install OpenCL
        run: |
          sudo apt-get update
          sudo apt-get install -y ocl-icd-opencl-dev opencl-headers pocl-opencl-icd

      - uses: Swatinem/rust-cache@v2

      - name: Run tests
        run: cargo test --verbose

  build:
    name: Build
    needs: version-change-check
    if: |
      always() &&
      (needs.version-change-check.result == 'success' ||
       needs.version-change-check.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install OpenCL
        run: |
          sudo apt-get update
          sudo apt-get install -y ocl-icd-opencl-dev opencl-headers pocl-opencl-icd

      - uses: Swatinem/rust-cache@v2

      - name: Build
        run: cargo build --verbose --release
