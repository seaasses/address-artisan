name: CI

on:
  pull_request:
    branches: ["main", "playground"]
  push:
    branches: ["main", "playground"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  version-change-check:
    name: Version Change Validation
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version_check.outputs.version }}
      should_release: ${{ steps.version_check.outputs.should_release }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check version change isolation
        id: version_check
        run: |
          BASE_REF="${{ github.event.pull_request.base.sha }}"
          HEAD_REF="${{ github.event.pull_request.head.sha }}"

          CURRENT_VERSION=$(grep '^version = ' Cargo.toml | head -1 | cut -d'"' -f2)
          LATEST_TAG=$(git tag -l "v*" --sort=-v:refname | head -1)

          if [ -z "$LATEST_TAG" ]; then
            echo "First release: $CURRENT_VERSION"
            PREVIOUS_VERSION=""
          else
            PREVIOUS_VERSION=$(git show $LATEST_TAG:Cargo.toml | grep '^version = ' | head -1 | cut -d'"' -f2)
          fi

          if [ -z "$PREVIOUS_VERSION" ] || [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            if [ -n "$PREVIOUS_VERSION" ]; then
              echo "Version changed: $PREVIOUS_VERSION → $CURRENT_VERSION"
            fi

            if [ -n "$PREVIOUS_VERSION" ]; then
              PREV_MAJOR=$(echo $PREVIOUS_VERSION | cut -d. -f1)
              PREV_MINOR=$(echo $PREVIOUS_VERSION | cut -d. -f2)
              PREV_PATCH=$(echo $PREVIOUS_VERSION | cut -d. -f3)

              CURR_MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
              CURR_MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
              CURR_PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)

              VALID_BUMP=false

              if [ $CURR_MAJOR -eq $((PREV_MAJOR + 1)) ] && [ $CURR_MINOR -eq 0 ] && [ $CURR_PATCH -eq 0 ]; then
                VALID_BUMP=true
              elif [ $CURR_MAJOR -eq $PREV_MAJOR ] && [ $CURR_MINOR -eq $((PREV_MINOR + 1)) ] && [ $CURR_PATCH -eq 0 ]; then
                VALID_BUMP=true
              elif [ $CURR_MAJOR -eq $PREV_MAJOR ] && [ $CURR_MINOR -eq $PREV_MINOR ] && [ $CURR_PATCH -eq $((PREV_PATCH + 1)) ]; then
                VALID_BUMP=true
              fi

              if [ "$VALID_BUMP" = false ]; then
                echo "Invalid version bump: $PREVIOUS_VERSION → $CURRENT_VERSION"
                echo "Valid options:"
                echo "  MAJOR: $((PREV_MAJOR + 1)).0.0"
                echo "  MINOR: $PREV_MAJOR.$((PREV_MINOR + 1)).0"
                echo "  PATCH: $PREV_MAJOR.$PREV_MINOR.$((PREV_PATCH + 1))"
                exit 1
              fi
            fi

            if [ "${{ github.event_name }}" == "pull_request" ]; then
              CHANGED_FILES=$(git diff --name-only $BASE_REF $HEAD_REF)
              NUM_CHANGED=$(echo "$CHANGED_FILES" | wc -l)
              EXPECTED_NOTES_FILE="docs/release-notes/v$CURRENT_VERSION.md"

              if [ $NUM_CHANGED -ne 3 ]; then
                echo "Must modify exactly 3 files: Cargo.toml, Cargo.lock, and $EXPECTED_NOTES_FILE ($NUM_CHANGED files changed)"
                echo "$CHANGED_FILES"
                exit 1
              fi

              if ! echo "$CHANGED_FILES" | grep -q "^Cargo.toml$"; then
                echo "Cargo.toml must be modified"
                exit 1
              fi

              if ! echo "$CHANGED_FILES" | grep -q "^Cargo.lock$"; then
                echo "Cargo.lock must be modified"
                exit 1
              fi

              if ! echo "$CHANGED_FILES" | grep -q "^$EXPECTED_NOTES_FILE$"; then
                echo "Release notes file must be modified: $EXPECTED_NOTES_FILE"
                echo "Changed files:"
                echo "$CHANGED_FILES"
                exit 1
              fi

              LOCK_VERSION=$(awk '/^\[\[package\]\]$/,/^$/ {if (/^name = "address-artisan"/) {in_pkg=1} if (in_pkg && /^version = /) {print; exit}}' Cargo.lock | cut -d'"' -f2)

              if [ "$CURRENT_VERSION" != "$LOCK_VERSION" ]; then
                echo "Version mismatch: Cargo.toml=$CURRENT_VERSION, Cargo.lock=$LOCK_VERSION"
                exit 1
              fi
            fi
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "version=" >> $GITHUB_OUTPUT
          fi

  format:
    name: Format Check
    needs: version-change-check
    if: |
      always() &&
      (needs.version-change-check.result == 'success' ||
       needs.version-change-check.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy Lints
    needs: version-change-check
    if: |
      always() &&
      (needs.version-change-check.result == 'success' ||
       needs.version-change-check.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - uses: Swatinem/rust-cache@v2

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    name: Tests
    needs: version-change-check
    if: |
      always() &&
      (needs.version-change-check.result == 'success' ||
       needs.version-change-check.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install OpenCL
        run: |
          sudo apt-get update
          sudo apt-get install -y ocl-icd-opencl-dev opencl-headers pocl-opencl-icd

      - uses: Swatinem/rust-cache@v2

      - name: Run tests
        run: cargo test --verbose

  build:
    name: Build
    needs: version-change-check
    if: |
      always() &&
      (needs.version-change-check.result == 'success' ||
       needs.version-change-check.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install OpenCL
        run: |
          sudo apt-get update
          sudo apt-get install -y ocl-icd-opencl-dev opencl-headers pocl-opencl-icd

      - uses: Swatinem/rust-cache@v2

      - name: Build
        run: cargo build --verbose --release

  pr-comment:
    name: PR Comment
    needs: [version-change-check, format, clippy, test, build]
    if: |
      github.event_name == 'pull_request' &&
      needs.version-change-check.outputs.should_release == 'true' &&
      needs.format.result == 'success' &&
      needs.clippy.result == 'success' &&
      needs.test.result == 'success' &&
      needs.build.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v5

      - name: Post PR comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.version-change-check.outputs.version }}"
          NOTES_FILE="docs/release-notes/v${VERSION}.md"
          RELEASE_NOTES=$(cat "$NOTES_FILE")

          cat > comment.md << EOF
          ## This is a release PR

          When this PR is merged to \`main\`, the release \`v${VERSION}\` will be automatically created with the following notes:

          ${RELEASE_NOTES}

          EOF

          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md
