name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: ["main", "playground"]

permissions:
  contents: write

jobs:
  check-version:
    name: Check Version
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check.outputs.version }}
      should_release: ${{ steps.check.outputs.should_release }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Check version change
        id: check
        run: |
          CURRENT_VERSION=$(grep '^version = ' Cargo.toml | head -1 | cut -d'"' -f2)
          LATEST_TAG=$(git tag -l "v*" --sort=-v:refname | head -1)

          if [ -z "$LATEST_TAG" ]; then
            echo "First release: $CURRENT_VERSION"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          else
            PREVIOUS_VERSION=$(git show $LATEST_TAG:Cargo.toml | grep '^version = ' | head -1 | cut -d'"' -f2)

            if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
              echo "Version changed: $PREVIOUS_VERSION â†’ $CURRENT_VERSION"
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            else
              echo "No version change"
              echo "should_release=false" >> $GITHUB_OUTPUT
              echo "version=" >> $GITHUB_OUTPUT
            fi
          fi

  create-release:
    name: Create GitHub Release
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Create tag and GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          TAG_NAME="v$VERSION"

          RELEASE_NOTES=$(awk '
            /\[package\.metadata\.release\]/ { in_section=1; next }
            in_section && /^notes = """/ { in_notes=1; next }
            in_notes && /^"""/ { exit }
            in_notes { print }
          ' Cargo.toml)

          if [ -z "$RELEASE_NOTES" ]; then
            RELEASE_NOTES="Release $TAG_NAME"
          fi

          gh release create "$TAG_NAME" \
            --title "Release $TAG_NAME" \
            --notes "$RELEASE_NOTES" \
            --target ${{ github.event.workflow_run.head_sha }}

          echo "Release $TAG_NAME created"

  build-linux-binaries:
    name: Build Linux Binaries
    needs: [check-version, create-release]
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            platform: linux-x86_64
          - target: aarch64-unknown-linux-gnu
            platform: linux-arm64
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build for ${{ matrix.platform }}
        run: cross build --release --target ${{ matrix.target }}

      - name: Strip and package binary
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          TARGET="${{ matrix.target }}"
          PLATFORM="${{ matrix.platform }}"

          cd target/$TARGET/release

          # Strip binary
          strip address-artisan 2>/dev/null || true

          # Create temporary directory for tarball
          mkdir -p address-artisan-v$VERSION-$PLATFORM
          cp address-artisan address-artisan-v$VERSION-$PLATFORM/
          cp ${{ github.workspace }}/README.md address-artisan-v$VERSION-$PLATFORM/
          cp ${{ github.workspace }}/LICENSE address-artisan-v$VERSION-$PLATFORM/

          # Create tarball
          tar czf address-artisan-v$VERSION-$PLATFORM.tar.gz address-artisan-v$VERSION-$PLATFORM

          # Move to project root
          mv address-artisan-v$VERSION-$PLATFORM.tar.gz ${{ github.workspace }}/

      - name: Upload to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          PLATFORM="${{ matrix.platform }}"
          TAG_NAME="v$VERSION"

          gh release upload "$TAG_NAME" \
            "address-artisan-v$VERSION-$PLATFORM.tar.gz" \
            --clobber

  publish:
    name: Publish to crates.io
    needs: [check-version, create-release]
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish release
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          echo "ðŸ“¦ Publishing version $VERSION to crates.io"

          # TODO: Replace with actual cargo publish
          echo "Simulated: cargo publish --token \$CARGO_REGISTRY_TOKEN"
