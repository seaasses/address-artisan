name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: ["main"]

permissions:
  contents: write

jobs:
  check-version:
    name: Check Version
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check.outputs.version }}
      should_release: ${{ steps.check.outputs.should_release }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Check version change
        id: check
        run: |
          CURRENT_VERSION=$(grep '^version = ' Cargo.toml | head -1 | cut -d'"' -f2)
          LATEST_TAG=$(git tag -l "v*" --sort=-v:refname | head -1)

          if [ -z "$LATEST_TAG" ]; then
            echo "First release: $CURRENT_VERSION"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          else
            PREVIOUS_VERSION=$(git show $LATEST_TAG:Cargo.toml | grep '^version = ' | head -1 | cut -d'"' -f2)

            if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
              echo "Version changed: $PREVIOUS_VERSION â†’ $CURRENT_VERSION"
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            else
              echo "No version change"
              echo "should_release=false" >> $GITHUB_OUTPUT
              echo "version=" >> $GITHUB_OUTPUT
            fi
          fi

  build-binaries:
    name: Build Binaries (${{ matrix.platform }})
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            platform: linux-x86_64
          - target: aarch64-unknown-linux-gnu
            platform: linux-arm64
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build for ${{ matrix.platform }}
        run: cross build --release --target ${{ matrix.target }}

      - name: Package binary
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          TARGET="${{ matrix.target }}"
          PLATFORM="${{ matrix.platform }}"

          cd target/$TARGET/release

          # Create temporary directory for tarball
          mkdir -p address-artisan-$VERSION-$PLATFORM
          cp address-artisan address-artisan-$VERSION-$PLATFORM/
          cp ${{ github.workspace }}/README.md address-artisan-$VERSION-$PLATFORM/
          cp ${{ github.workspace }}/LICENSE address-artisan-$VERSION-$PLATFORM/

          # Create tarball
          tar czf address-artisan-$VERSION-$PLATFORM.tar.gz address-artisan-$VERSION-$PLATFORM

          # Move to project root
          mv address-artisan-$VERSION-$PLATFORM.tar.gz ${{ github.workspace }}/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: address-artisan-${{ matrix.platform }}
          path: address-artisan-*.tar.gz
          retention-days: 1

  build-deb:
    name: Build .deb (${{ matrix.arch }})
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: amd64
          - target: aarch64-unknown-linux-gnu
            arch: arm64
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cross and cargo-deb
        run: |
          cargo install cross --git https://github.com/cross-rs/cross
          cargo install cargo-deb

      - name: Build for ${{ matrix.arch }}
        run: cross build --release --target ${{ matrix.target }}

      - name: Build .deb package
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          cargo deb --no-build --target ${{ matrix.target }}

          # Rename .deb to include architecture
          cd target/${{ matrix.target }}/debian
          DEB_FILE=$(ls *.deb)
          mv "$DEB_FILE" "address-artisan_${VERSION}_${{ matrix.arch }}.deb"

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: address-artisan-${{ matrix.arch }}-deb
          path: target/${{ matrix.target }}/debian/*.deb
          retention-days: 1

  create-release:
    name: Create GitHub Release
    needs: [check-version, build-binaries, build-deb]
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Create tag and GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          TAG_NAME="v$VERSION"
          NOTES_FILE="docs/release-notes/v$VERSION.md"

          gh release create "$TAG_NAME" \
            --title "Address Artisan $VERSION" \
            --notes-file "$NOTES_FILE" \
            --target ${{ github.event.workflow_run.head_sha }}

          echo "Release $TAG_NAME created"

  upload-binaries:
    name: Upload Binaries to Release
    needs: [check-version, create-release]
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: address-artisan-*
          merge-multiple: true

      - name: Upload to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          TAG_NAME="v$VERSION"

          gh release upload "$TAG_NAME" \
            address-artisan-*.tar.gz \
            address-artisan_*.deb \
            --clobber

  publish:
    name: Publish to crates.io
    needs: [check-version, upload-binaries]
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install OpenCL dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ocl-icd-opencl-dev opencl-headers

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          echo "ðŸ“¦ Publishing version $VERSION to crates.io..."

          cargo publish --token "$CARGO_REGISTRY_TOKEN"

          echo "âœ… Successfully published address-artisan v$VERSION to crates.io"
